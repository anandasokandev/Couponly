

<c-modal
  #FindStoreModal
  [scrollable]="true"
  alignment="center"
  id="FindStoreModal"
  class="wide-modal"
>
    <c-modal-header>
        <h5 cModalTitle>Find and Add Store Contacts</h5>
        <button
            [cModalToggle]="FindStoreModal.id"
            class="btn-close btn-sm"
            cButtonClose
            >
        </button>
    </c-modal-header>

    <c-modal-body class="p-4">
        <h6 class="mb-1">Choose Store</h6>
        <form [formGroup]="filterForm">
            <!-- <div class="d-flex gap-3 py-3">
                <select class="form-select form-select-sm" formControlName="district">
                    <option value=0 [selected]="districtId === 0">All Distircts</option>
                    <option *ngFor="let district of districts" [value]="district.id" [selected]="districtId === district.id">{{ district.districtName }}</option>
                </select>
                <select class="form-select form-select-sm" formControlName="location">
                    <option value=0 [selected]="locationId === 0">All Locations</option>
                    <option *ngFor="let location of locations" [value]="location.id" [selected]="locationId === location.id">{{ location.locationName }}</option>

                </select>
                <select class="form-select form-select-sm" formControlName="category">
                    <option value=0 [selected]="categoryId === 0">All Categories</option>
                    <option *ngFor="let category of categories" [value]="category.id" [selected]="categoryId === category.id">{{ category.name }}</option>
                </select>
            </div> -->
            <div class="d-flex gap-4">
                <c-input-group>
                    <span cInputGroupText>
                        <i class="fas fa-search"></i>
                    </span>
                    <input cFormControl class="form-control-sm" type="text" formControlName="storeName" placeholder="Search by name...">
                </c-input-group>
                <button cButton color="secondary" class="btn btn-sm d-flex align-items-center" (click)="searchStores()" [disabled]="!searchtext || isStoreLoading">
                    Search <i class="fas fa-search ms-2"></i></button>
            </div>
        </form>

    <hr>

    <ng-container *ngIf="storeBox">
        <h6>Search Results</h6>

        <div *ngIf="isStoreLoading" class="d-flex justify-content-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <ng-container *ngIf="searchResults && searchResults.length > 0 && !isStoreLoading">
            <table [hover]="true" cTable class="responsive-table">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Logo</th>
                    <th>Store Name</th>
                    <th>available Contacts</th>
                    <!-- <th>Action</th> -->
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let store of searchResults; let i = index" class="align-middle" (click)="selectStore(store)" style="cursor: pointer;">
                    <td>{{ currentPage * itemsPerPage - itemsPerPage + i + 1 }}</td>
                    <td><img [src]="store.storeLogo" class="img"></td>
                    <td>{{store.store}}</td>
                    <td></td>
                    <!-- <td>
                    <button cButton class="btn-sm" variant="ghost" [disabled]="store === selectedStore">
                        <i class="fas fa-check"></i>
                    </button>
                    </td> -->
                </tr>
                <tr *ngIf="searchResults.length === 0">
                    <td colspan="4">No stores found. Please adjust your filters.</td>
                </tr>
                </tbody>
            </table>

            <app-pagination 
                [currentPage]="currentPage"
                [itemsPerPage]="itemsPerPage"
                [totalItems]="totalItems"
                [fromModel]="true"
                (pageChange)="onPageChange($event)"
            ></app-pagination>
        </ng-container>
    </ng-container>

    <div class="mt-2" *ngIf="couponBox">
        <table [hover]="true" cTable class="responsive-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Logo</th>
                    <th>Store Name</th>
                    <th>available Contacts</th>
                </tr>
            </thead>
            <tbody>
                <tr class="align-middle">
                    <td>1</td>
                    <td><img [src]="selectedStore.storeLogo" class="img"></td>
                    <td>{{ selectedStore.store }}</td> 
                    <td></td>
                </tr>
            </tbody>
        </table>

        <h6 class="mt-3">Choose Coupon details</h6>
        <div class="d-flex gap-4">
            <c-input-group>
                <span cInputGroupText>
                    <i class="fas fa-search"></i>
                </span>
                <input cFormControl class="form-control-sm" type="text" [(ngModel)]="couponText" placeholder="Search by coupon code...">
            </c-input-group>
            <button cButton color="secondary" class="btn btn-sm d-flex align-items-center" (click)="searchCoupon()" [disabled]="!couponText || isCouponLoading">
                Search <i class="fas fa-search ms-2"></i>
            </button>
        </div>
        <div class="d-flex flex-row flex-wrap gap-4 justify-content-center">
            <div *ngFor="let coupon of couponDetails" class="card p-2 mt-2 d-flex flex-row" style="width: 45%; text-decoration: none; cursor: pointer;" (click)="selectCoupon(coupon)">
                <img [src]="coupon.couponImage" class="card-img-top" alt="...">
                <div class="card-body">
                    <h6 class="card-title">{{ coupon.couponCode }}</h6>
                    <p class="card-text">{{ coupon.name }}</p>
                </div>
            </div>
        </div>
        <div *ngIf="!couponDetails && !selectedCoupon" class="mt-3">
            <p>No coupon details found. Please adjust your search.</p>
        </div>
        <div *ngIf="isCouponLoading" class="d-flex justify-content-center my-2">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <div *ngIf="!storeBox && !couponBox" class="mt-4">
        <div *ngIf="selectedStore" class="selection-area">
            <p>You have selected: <strong>{{ selectedStore.store }}</strong> ({{ StoreContactCount }} contacts available under {{ selectedStore.store }})</p>
            <p>Coupon: <strong>{{ selectedCoupon?.couponCode || 'None selected' }}</strong></p>
            <p>Contacts available in public repo.: {{ PublicContactCount }}</p>
            <div class="d-flex gap-3">
                <label for="contactsNeeded">No.of contacts for promotion:</label>
                <input
                    type="number"
                    cFormControl
                    class="form-control-sm"
                    id="contactsNeeded"
                    [(ngModel)]="contactsNeeded"
                    [max]="PublicContactCount"
                    min="1"
                    style="width: 100px; text-align: right;"
                    (change)="checkContactsNeeded()"
                    >
                <span>/ {{ PublicContactCount }}</span>
            </div>
        </div>
        <p *ngIf="!selectedStore">No results found. Please adjust your filters.</p>
    </div>

    
    </c-modal-body>

    <c-modal-footer>
    <button cButton class="btn-sm" color="secondary" [cModalToggle]="FindStoreModal.id">Cancel</button>
    <button
        cButton
        type="button"
        class="btn-sm"
        color="primary"
        (click)="addContacts()"
        [disabled]="!selectedStore || !selectedCoupon || contactsNeeded <= 0 || contactsNeeded > PublicContactCount"
        [cModalToggle]="FindStoreModal.id"
    >
        Select Store
    </button>
    </c-modal-footer>

</c-modal>